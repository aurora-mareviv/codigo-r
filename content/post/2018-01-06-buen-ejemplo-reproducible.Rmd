---
title: C칩mo hacer un buen ejemplo reproducible en R
author: Elio Campitelli
date: '2018-01-06'
slug: buen-ejemplo-reproducible-en-r
categories:
  - R
tags: [] 
---

Es muy dif칤cil dar ayuda si no se sabe cu치l es el problema. Un buen ejemplo de lo que est치 mal que cualquiera pueda correr en sus computadoras es casi esencial para recibir ayuda. 

Un buen ejemplo reproducible (o reprex) es b치sicamente el feliz matrimonio entre un set de datos **m칤nimo** y un c칩digo **m칤nimo** que ilustre el problema y que cualquiera pueda copiar, pegar en un script y obtener **exactamente los mismos resultados**. 

Obtener un reprex m칤nimo no es una tarea trivial. A veces puede tomar m치s de media hora y dar ma콑 de un dolor de cabeza. Pero en el proceso uno aprende mucho sobre las caracter칤sticas espec칤ficas de su problema y a veces incluso termina por resolverlo solo. A칰n si no se resuelve, el tiempo que uno invierte en hacer el ejemplo reproducible implican m치s chances de que alg칰n usuario responda, m치s r치pido y con m치s claridad.

## Datos m칤nimos

Hay dos formas principales de obtener sets de datos para ejemplos reproducibles, cre치ndolos uno mismo o usando datos que vienen en distintos paquetes. La cantidad de sets de datos a los que cualquier usuario de R puede tener acceso sin salir de casa [es inmensa](http://vincentarelbundock.github.io/Rdatasets/datasets.html). Distintos datos sirven para ilustrar distintos problemas. 

Por ejemplo, yo trabajo mucho con datos espaciales en grillas regulares y si quiero probar algo uso mucho el dataset `volcano`, que tiene informaci칩n topogr치fica del volc치n Maunga Whau en Auckland con una resoluci칩n de 10m. Como es una matriz y en general prefiero trabajar con data.frames, para usarla tengo que usar `reshape2::melt()`

```{r}
library(ggplot2)
ggplot(reshape2::melt(volcano), aes(Var1, Var2)) +
   geom_contour(aes(z = value, color = ..level..)) +
   coord_equal()
```

Para datos m치s puntales, `ggplot2` tiene el dataset `diamonds` que contiene m치s de 50.000 filas de datos num칠ricos y factores

```{r}
ggplot(diamonds, aes(carat, price)) +
   geom_point(aes(color = clarity)) +
   facet_grid(color ~ cut)
```

Y para el que prefiera autos de lujo a anillos de diamnates, est치 `mtcars`. 

Si uno prefiere usar datos ficticios, siempre puede generar n칰meros aleatorios con `rnorm`, `runif`, `rgamma` o cualquier otra distribuci칩n (ver `?distributions` para una lista). **Siempre** que uno use alguna de estas funciones tiene que setear la semilla del generador de n칰meros aleatorios con `set.seed()`. De esta forma uno se asegura que todo aquel que ejecute el c칩digo obtenga exactamente los mismos n칰meros (pero aleatorios 游뱂).

Una funci칩n que a m칤 me resolvi칩 much칤simos problemas es `expand.grid`. Devuelve un data.frame con todas las combinaciones de los elementos de distintos vectores. Es una funci칩n muy flexible que puede ser usada para generar una grilla regular

```{r}
df <- expand.grid(x = 1:10, y = 1:10)
df$z <- with(df, x*y)
ggplot(df, aes(x, y)) +
   geom_tile(aes(fill = z))
```

o para asignar valores a distintos factores

```{r}
library(ggplot2)
df <- expand.grid(tiempo = 1:30, sujeto = factor(letters[1:3]))
set.seed(42)
df$valor <- with(df, tiempo*0.1*as.numeric(sujeto) + rnorm(nrow(df)))
ggplot(df, aes(tiempo, valor, color = sujeto)) +
   geom_line()
```

A veces los problemas dependen de los datos utilizados. Si resulta imposible reproducir un problema con datos p칰blicos o artificiales, la 칰ltima opci칩n es compartir los datos propios. En ese caso, lo que uno debe hacer es minimizar los datos para que puedan ser compartidos f치cilmente. Por ejemplo, yo estaba teniendo unos problemas con unos datos de [funci칩n corriente](https://en.wikipedia.org/wiki/Stream_function) para distintos modelos clim치ticos y distintas estaciones. Parte de resolverlo implic칩 reducirlo a s칩lo un campo.  

Si los datos reducidos quedan bastante chicos, la manera m치s f치cil de compartirlos es con la funci칩n `dput`, que convierte un objeto de R en un c칩digo que lo reproduce:

```{r}
dput(cars)
```

Si a칰n reduci칠ndolo al m칤nimo los datos son demasiado grandes o complicados para compartirlos como texto, la mejor opci칩n es guardarlo como un archivo .Rds

```{r eval=FALSE}
saveRDS(diamonds, file = "diamonds.Rds")
```

y luego subir el archivo a alg칰n sitio de intercambio. 

En el c칩digo de ejemplo, leer los archivos con 

```{r eval = FALSE}
diamonds <- readRDS("diamonds.Rds")
```

## C칩digo m칤nimo 

Una vez que se tiene la menor cantidad de datos que reproducen un problema, lo que sigue es minimizar el c칩digo. A veces puede ser complicado, pero a grandes rasgos son cuestiones obvias. 

Cargar la menor cantidad de paquetes posibles. No crear variables innecesariamente. Si es una cuesti칩n con gr치ficos, sacar la mayor cantidad de personalizaci칩n posible (usar las escalas default en `ggplot2`, por ejemplo). 

Personalmente, si el c칩digo original usa sintaxis de `dplyr` o `data.table` (mi favorita 游눞), trato de reducir todo a R base. Casi seguro que el problema no est치 ah칤 y no est치 bueno obligar a otros a instalar paquetes nuevos para ayudar. 

Todo esto requiere una intuici칩n de d칩nde podr칤a estar el error pero en caso de no tenerla, ayuda a desarrollarla. Ir sacando pedazos de c칩digo y chequeando si el problema continua es una buena forma de encontrar la causa del problema. Como dijo Sherlock: 

> Una vez descartado lo imposible, el c칩digo que queda, por improbable que parezca, debe ser la causa del error. 

(o algo as칤)

## Finalmente

Una vez que est치n los datos m칤nimos y el c칩digo m칤nimo, hay que compartir todo eso. Uno de mis paquetes favoritos y que uso constantemente es [`reprex`](https://github.com/tidyverse/reprex). Es un paquete pensado especialmente para hacer desaparecer todas las dificultades de compartir c칩digo y es incre칤blemente f치cil de usar. 

Una vez que se tiene el c칩digo escrito, lo 칰nico que hay que hacer es copiarlo todo al portapapeles y correr `reprex::reprex()` para que lo corra y copie el resultado en el portapapeles. Si hay gr치ficos, los sube autom치ticamente a imgur y genera los tags correctos para que se vean bien. Muestra los mensajes de error que aparezcan y permite elegir distintas convenciones de c칩digo seg칰n si queremos compartir nuestro ejemplo en GitHub, StackOverflow o un script de R. 

Por ejemplo, d치ndole el c칩digo anterior, `reprex` devuelve esto:


````
```r
library(ggplot2)
df <- expand.grid(tiempo = 1:30, sujeto = factor(letters[1:3]))
dfset.seed(42)
$valor <- with(df, tiempo*0.1*as.numeric(sujeto) + rnorm(nrow(df)))
ggplot(df, aes(tiempo, valor, color = sujeto)) +
   geom_line()
```

![](https://i.imgur.com/51BdMze.png)

````

Que est치 listo para pegar en GitHub y que salga todo perfecto. 

## Buen reprex mata gal치n

Pedir ayuda o reportar bugs con un buen ejemplo m칤nimo reproducible mejora la calidad de las consultas, ayuda a los que quieren ayudar, te hace ganar amigos y bajar 7 libras en 2 semanas. Sea bueno, haga un reprex. 